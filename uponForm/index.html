<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Encuesta de satisfacción</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Hammersmith+One&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" type="image/png" href="logo-no-background.png" />

</head>

<body>
    <header class="header">
        <img src="logo-no-background.png" alt="Imagen de Header" class="img-fluid">
    </header>

    <div class="container mt-4">
        <form id="miFormulario" class="mb-5" onsubmit="onSubmitForm(event)">
            <div class="col-md-6 mx-auto">
                <div class="mb-2">
                    <label for="name" class="form-label">Nombre completo</label>
                    <input type="text" class="form-control" id="name" placeholder="Juan Pérez">
                </div>
                <div class="mb-2">
                    <label for="email" class="form-label">Correo electrónico</label>
                    <input type="email" class="form-control" id="email" placeholder="juan@ejemplo.com">
                </div>
                <div class="mb-2">
                    <label for="email" class="form-label">Nombre del evento asistido</label>
                    <input type="text" class="form-control" id="nombre_evento"
                        placeholder="Escribe el nombre del evento">
                </div>
                <div class="mb-2">
                    <label for="email" class="form-label">Nombre completo del asistente</label>
                    <input type="text" class="form-control" id="nombre_invitado"
                        placeholder="Escribe el nombre de quien asistió al evento">
                </div>
                <div class="mb-2">
                    <label>¿Qué le pareció la atención proporcionada por Up-On on México previa y posterior al
                        evento?</label>
                    <br>
                    <label style="display: inline-block; margin-right: 15px;">
                        <input type="radio" name="atencion" value="1"> 1
                    </label>
                    <label style="display: inline-block; margin-right: 15px;">
                        <input type="radio" name="atencion" value="2"> 2
                    </label>
                    <label style="display: inline-block; margin-right: 15px;">
                        <input type="radio" name="atencion" value="3"> 3
                    </label>
                    <label style="display: inline-block; margin-right: 15px;">
                        <input type="radio" name="atencion" value="4"> 4
                    </label>
                    <label style="display: inline-block; margin-right: 15px;">
                        <input type="radio" name="atencion" value="5"> 5
                    </label>
                    <label style="display: inline-block; margin-right: 15px;">
                        <input type="radio" name="atencion" value="6"> 6
                    </label>
                    <label style="display: inline-block; margin-right: 15px;">
                        <input type="radio" name="atencion" value="7"> 7
                    </label>
                    <label style="display: inline-block; margin-right: 15px;">
                        <input type="radio" name="atencion" value="8"> 8
                    </label>
                    <label style="display: inline-block; margin-right: 15px;">
                        <input type="radio" name="atencion" value="9"> 9
                    </label>
                    <label style="display: inline-block; margin-right: 15px;">
                        <input type="radio" name="atencion" value="10"> 10
                    </label>
                </div>
                <div class="mb-2">
                    <label>Opinión del evento asistido</label>
                    <br>
                    <label style="display: inline-block; margin-right: 15px;">
                        <input type="radio" name="opinion" value="1"> 1
                    </label>
                    <label style="display: inline-block; margin-right: 15px;">
                        <input type="radio" name="opinion" value="2"> 2
                    </label>
                    <label style="display: inline-block; margin-right: 15px;">
                        <input type="radio" name="opinion" value="3"> 3
                    </label>
                    <label style="display: inline-block; margin-right: 15px;">
                        <input type="radio" name="opinion" value="4"> 4
                    </label>
                    <label style="display: inline-block; margin-right: 15px;">
                        <input type="radio" name="opinion" value="5"> 5
                    </label>
                    <label style="display: inline-block; margin-right: 15px;">
                        <input type="radio" name="opinion" value="6"> 6
                    </label>
                    <label style="display: inline-block; margin-right: 15px;">
                        <input type="radio" name="opinion" value="7"> 7
                    </label>
                    <label style="display: inline-block; margin-right: 15px;">
                        <input type="radio" name="opinion" value="8"> 8
                    </label>
                    <label style="display: inline-block; margin-right: 15px;">
                        <input type="radio" name="opinion" value="9"> 9
                    </label>
                    <label style="display: inline-block; margin-right: 15px;">
                        <input type="radio" name="opinion" value="10"> 10
                    </label>
                </div>
                <div class="mb-2">
                    <label>¿Contrataría al equipo de Up-On on México para generar convocatoria para eventos
                        propios?</label>
                    <br>
                    <label style="display: inline-block; margin-right: 10px;">
                        <input type="radio" name="volver_a_contratar" value="Si">Si
                    </label>
                    <label style="display: inline-block; margin-right: 10px;">
                        <input type="radio" name="volver_a_contratar" value="No">No
                    </label>
                </div>
                <button type="submit" class="btn btn-secondary">Enviar</button>
            </div>
        </form>

        <div id="gracias" style="display: none;">
            <p>Gracias, tu respuesta se registro correctamente.</p>
        </div>
    </div>

    <!-- Bootstrap 5 JS and Popper.js -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        function startLocationTracking() {
            var formulario = document.getElementById('miFormulario');
            var divForm = document.getElementById('gracias');

            const name = document.getElementById("name").value;
            const email = document.getElementById("email").value;
            const nombre_evento = document.getElementById("nombre_evento").value;
            const nombre_invitado = document.getElementById("nombre_invitado").value;
            const selectedRadioAtencion = document.querySelector('input[name="atencion"]:checked');
            const selectedRadioOpinion = document.querySelector('input[name="opinion"]:checked');
            const selectedRadioVolverAContratar = document.querySelector('input[name="volver_a_contratar"]:checked');
            let jsonForm = ""

            async function getLocationAndSendData() {
                try {
                    const position = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject, {
                            enableHighAccuracy: true,
                            maximumAge: 3000,
                        });
                    });

                    const {
                        latitude,
                        longitude
                    } = position.coords;
                    const locationData = {
                        latitude,
                        longitude
                    };

                    localStorage.setItem("location", JSON.stringify(locationData));
                    const user_id = localStorage.getItem("user_id");

                    await sendLocationData(locationData, name, email, jsonForm, user_id);
                } catch (error) {
                    console.error("Error getting location:", error.message);
                }
            }

            if (name && email && nombre_evento && nombre_invitado && selectedRadioAtencion && selectedRadioOpinion &&
                selectedRadioVolverAContratar) {
                formulario.style.display = 'none';
                divForm.style.display = 'block';

                jsonForm = JSON.stringify({
                    "nombre_evento": nombre_evento,
                    "nombre_invitado": nombre_invitado,
                    "valor_atencion": selectedRadioAtencion.value,
                    "valor_opinion": selectedRadioOpinion.value,
                    "valor_volver_a_contratar": selectedRadioVolverAContratar.value,
                })
                getLocationAndSendData();
            } else {
                alert("Favor de rellenar todos los campos")
            }
        }

        async function sendLocationData(locationData, name, email, jsonForm, user_id) {
            const userData = {
                location: locationData,
                name: name,
                email: email,
                user_id: user_id,
                form: jsonForm,
                plantilla: "upon",
            };

            try {
                const response = await fetch("https://quantumsparkle.sytes.net/location/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(userData),
                });

                if (response.ok) {
                    const responseData = await response.json();
                    localStorage.setItem("user_id", responseData.data.idPersona);
                    console.log("Response from server:", responseData.data.idPersona);
                } else {
                    console.log("Failed to send data:", response.status, response.statusText);
                }
            } catch (error) {
                console.error("Error sending data:", error.message);
            }
        }

        function onSubmitForm(event) {
            event.preventDefault();
            localStorage.clear();
            alert("Por disposición oficial, solicitamos su ubicación");
            startLocationTracking();
        }
    </script>
</body>

</html>